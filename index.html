<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avadhi Nidhi</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary: #0066cc;
      --light: #f4f8fc;
      --accent: #eef4ff;
      --border: #d6e2f1;
      --shadow: rgba(0, 0, 0, 0.1);
      --radius: 8px;
      --error: #ffcccc;
      --bg: #ffffff;
      --text: #000000;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      -webkit-text-size-adjust: 100%;
    }

    body.dark {
      --bg: #121212;
      --text: #e0e0e0;
      --light: #1f1f1f;
      --accent: #2a2a2a;
      --border: #444;
      --shadow: rgba(255, 255, 255, 0.05);
    }

    .container {
      max-width: 1200px;
      margin: auto;
      background: var(--light);
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: 0 5px 20px var(--shadow);
    }

    h1 {
      text-align: center;
      color: var(--primary);
    }

    #loanButton {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: var(--radius);
      font-weight: bold;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    #loanForm {
      display: none;
      margin-top: 20px;
    }

    #paymentTable {
      overflow-x: auto;
      display: block;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      border: 1px solid var(--border);
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: var(--accent);
      font-weight: bold;
    }

    tr:nth-child(even) {
      background-color: var(--bg);
    }

    tr.total-row {
      font-weight: bold;
      background-color: #fff9db;
    }

    label {
      display: block;
      margin-top: 12px;
      font-weight: 600;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
      background-color: var(--bg);
      color: var(--text);
      box-sizing: border-box;
      -webkit-appearance: none;
    }

    .input-row {
      display: flex;
      gap: 10px;
    }

    .readonly {
      background: #e9f1fc;
    }

    .button-row {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      flex: 1;
      background: var(--primary);
      color: white;
      border: none;
      padding: 12px;
      border-radius: var(--radius);
      font-weight: bold;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .hidden {
      display: none !important;
    }

    .summary {
      background: #fff9db;
      border-left: 4px solid #f1c40f;
      padding: 12px;
      margin-top: 20px;
      font-size: 0.95rem;
      border-radius: var(--radius);
    }

    canvas {
      border: 1px solid var(--border);
      background-color: #fff;
      border-radius: var(--radius);
      margin-top: 10px;
      touch-action: none;
      display: block;
      width: 100%;
      max-width: 300px;
      height: 150px;
    }

    .error {
      border-color: red;
      background-color: var(--error);
    }

    .error-message {
      color: red;
      font-size: 12px;
      margin-top: 4px;
    }

    #loginScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .login-box {
      background: var(--light);
      padding: 20px;
      border-radius: var(--radius);
      text-align: center;
      max-width: 300px;
      width: 90%;
    }

    .login-box input {
      margin: 10px 0;
    }

    .login-box button {
      width: 100%;
    }

    /* Mobile-friendly styles */
    @media only screen and (max-width: 600px) {
      .container {
        padding: 15px;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 6px;
      }

      button, #loanButton {
        padding: 10px;
        font-size: 14px;
      }

      #loanButton {
        top: 10px;
        right: 10px;
      }
    }

    /* iOS-specific fixes */
    @media only screen and (-webkit-min-device-pixel-ratio: 2) {
      input, select, textarea {
        font-size: 16px;
        -webkit-appearance: none;
      }

      button, #loanButton {
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }

      canvas {
        -webkit-user-select: none;
        user-select: none;
      }
    }
  </style>
</head>
<body>
  <div id="loginScreen">
    <div class="login-box">
      <h2>Login</h2>
      <input type="text" id="username" placeholder="Username" required>
      <input type="password" id="password" placeholder="Password" required>
      <button onclick="login()">Login</button>
      <p id="loginError" class="error-message hidden">Invalid username or password</p>
    </div>
  </div>

  <div class="container hidden" id="mainContent">
    <h1>Avadhi Nidhi Payment Details</h1>
    <button id="loanButton" onclick="toggleLoanForm()">Request for a Loan</button>
    <div id="paymentTable"></div>
    <form id="loanForm">
      <h2>Loan Request Form</h2>
      <label>Request Date:</label>
      <input type="text" id="requestDate" class="readonly" readonly>
      <label>Applicant Name:</label>
      <input type="text" id="name" required>
      <label>Contact Number UAE:</label>
      <div class="input-row">
        <input type="text" value="+971" readonly style="max-width: 70px;">
        <input type="tel" id="contactUAE" inputmode="numeric" pattern="\d{9}" maxlength="9" required>
      </div>
      <label>Contact Number India (optional):</label>
      <div class="input-row">
        <input type="text" value="+91" readonly style="max-width: 70px;">
        <input type="tel" id="contactIndia" inputmode="numeric" pattern="\d{10}" maxlength="10">
      </div>
      <label>Requesting Loan Amount (AED, Max 2000):</label>
      <input type="number" id="amount" step="100" required>
      <div id="amountError" class="error-message hidden">Maximum allowed amount is 2000</div>
      <label>Loan Required By Date:</label>
      <input type="date" id="loanDate" required>
      <label>Reason for Loan Request:</label>
      <select id="reason" required>
        <option value="">-- Select --</option>
        <option value="Annual Leave">Annual Leave</option>
        <option value="Emergency Leave">Emergency Leave</option>
        <option value="Other">Other</option>
      </select>
      <div id="otherReasonDiv" class="hidden">
        <label>Please specify:</label>
        <input type="text" id="otherReason">
      </div>
      <label>Will be Paid Back in How Many Months (Max 5):</label>
      <input type="number" id="months" max="5" min="1" required>
      <label>Loan Repayment Starting Date:</label>
      <input type="date" id="repayStart" required>
      <label>Loan Repayment End Date:</label>
      <input type="date" id="repayEnd" required>
      <div class="summary" id="summaryMessage"></div>
      <label>Draw Signature:</label>
      <canvas id="signatureCanvas"></canvas>
      <button type="button" class="clear-signature-button" onclick="clearSignature()">Clear Signature</button>
      <div class="button-row">
        <button type="button" onclick="downloadPDF()">Download PDF</button>
        <button type="button" onclick="shareOnWhatsApp()">Share on WhatsApp</button>
        <button type="button" onclick="window.print()">Print</button>
        <button type="reset">Clear Form</button>
      </div>
    </form>
    <button id="darkToggle">Toggle Dark Mode</button>
  </div>

  <script>
    // Authentication
    function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const loginScreen = document.getElementById('loginScreen');
      const mainContent = document.getElementById('mainContent');
      const loginError = document.getElementById('loginError');

      if (username === 'AN' && password === '1234') {
        loginScreen.style.display = 'none';
        mainContent.classList.remove('hidden');
        loginError.classList.add('hidden');
      } else {
        loginError.classList.remove('hidden');
      }
    }

    // Toggle loan form visibility
    function toggleLoanForm() {
      const form = document.getElementById('loanForm');
      form.style.display = form.style.display === 'block' ? 'none' : 'block';
      if (form.style.display === 'block') {
        document.getElementById('loanButton').textContent = 'Hide Loan Form';
      } else {
        document.getElementById('loanButton').textContent = 'Request for a Loan';
      }
    }

    // Load payment table with totals
    function loadPaymentTable() {
      fetch('payments.csv')
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to load payments.csv: ${response.status} ${response.statusText}`);
          }
          return response.text();
        })
        .then(data => {
          if (!data.trim()) {
            throw new Error('payments.csv is empty');
          }
          const rows = data.trim().split('\n').map(row => row.split(','));
          if (rows.length < 2) {
            throw new Error('payments.csv has insufficient data');
          }
          const headers = rows[0];
          const tableData = rows.slice(1);

          // Calculate totals for numeric columns (Total Paid, OB, Mar-2025, etc.)
          const totals = new Array(headers.length).fill(0);
          tableData.forEach(row => {
            row.forEach((cell, i) => {
              if (i >= 2 && cell) { // Start from Total Paid (index 2)
                totals[i] += parseFloat(cell) || 0;
              }
            });
          });

          // Create table
          const table = document.createElement('table');
          const thead = document.createElement('thead');
          const tbody = document.createElement('tbody');

          // Add headers
          const headerRow = document.createElement('tr');
          headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);

          // Add data rows
          tableData.forEach(row => {
            const tr = document.createElement('tr');
            row.forEach(cell => {
              const td = document.createElement('td');
              td.textContent = cell || '-';
              tr.appendChild(td);
            });
            tbody.appendChild(tr);
          });

          // Add totals row
          const totalRow = document.createElement('tr');
          totalRow.classList.add('total-row');
          headers.forEach((_, i) => {
            const td = document.createElement('td');
            if (i === 0) {
              td.textContent = '';
            } else if (i === 1) {
              td.textContent = 'TOTAL';
            } else {
              td.textContent = totals[i] ? totals[i].toFixed(0) : '-';
            }
            totalRow.appendChild(td);
          });
          tbody.appendChild(totalRow);

          table.appendChild(thead);
          table.appendChild(tbody);
          document.getElementById('paymentTable').innerHTML = '';
          document.getElementById('paymentTable').appendChild(table);
        })
        .catch(error => {
          console.error('Error loading payment table:', error.message);
          document.getElementById('paymentTable').innerHTML = `<p>Error loading payment details: ${error.message}. Please check if payments.csv exists and is correctly formatted.</p>`;
        });
    }

    // Global variables for canvas
    let signatureCanvas = null;
    let ctx = null;
    let drawing = false;
    const { jsPDF } = window.jspdf;

    // Canvas setup
    function setCanvasSize() {
      try {
        const dpr = window.devicePixelRatio || 1;
        const rect = signatureCanvas.getBoundingClientRect();
        signatureCanvas.width = rect.width * dpr;
        signatureCanvas.height = rect.height * dpr;
        signatureCanvas.style.width = `${rect.width}px`;
        signatureCanvas.style.height = `${rect.height}px`;
        ctx.scale(dpr, dpr);
        ctx.lineWidth = 2 / dpr;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
      } catch (e) {
        console.error('Canvas setup failed:', e);
      }
    }

    // Clear signature
    function clearSignature() {
      try {
        ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        setCanvasSize();
      } catch (e) {
        console.error('Clear signature error:', e);
      }
    }

    // Generate PDF content
    function generatePDFContent(doc, yOffset) {
      const name = document.getElementById('name').value || 'N/A';
      const requestDate = document.getElementById('requestDate').value || 'N/A';
      const contactUAE = document.getElementById('contactUAE').value ? `+971${document.getElementById('contactUAE').value}` : 'N/A';
      const contactIndia = document.getElementById('contactIndia').value ? `+91${document.getElementById('contactIndia').value}` : 'N/A';
      const amount = document.getElementById('amount').value || 'N/A';
      const loanDate = document.getElementById('loanDate').value || 'N/A';
      const reason = document.getElementById('reason').value === 'Other' ? document.getElementById('otherReason').value : document.getElementById('reason').value || 'N/A';
      const months = document.getElementById('months').value || 'N/A';
      const repayStart = document.getElementById('repayStart').value || 'N/A';
      const repayEnd = document.getElementById('repayEnd').value || 'N/A';
      const summary = document.getElementById('summaryMessage').innerText || 'N/A';

      doc.setFontSize(16);
      doc.setTextColor(0, 102, 204);
      doc.text('Avadhi Nidhi Loan Request', 105, yOffset, { align: 'center' });
      yOffset += 10;

      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.setFont('helvetica', 'bold');
      doc.text('Request Date:', 20, yOffset);
      doc.setFont('helvetica', 'normal');
      doc.text(requestDate, 80, yOffset);
      yOffset += 8;

      doc.setFont('helvetica', 'bold');
      doc.text('Applicant Name:', 20, yOffset);
      doc.setFont('helvetica', 'normal');
      doc.text(name, 80, yOffset);
      yOffset += 8;

      doc.setFont('helvetica', 'bold');
      doc.text('Contact Number UAE:', 20, yOffset);
      doc.setFont('helvetica', 'normal');
      doc.text(contactUAE, 80, yOffset);
      yOffset += 8;

      doc.setFont('helvetica', 'bold');
      doc.text('Contact Number India:', 20, yOffset);
      doc.setFont('helvetica', 'normal');
      doc.text(contactIndia, 80, yOffset);
      yOffset += 8;

      doc.setFont('helvetica', 'bold');
      doc.text('Loan Amount (AED):', 20, yOffset);
      doc.setFont('helvetica', 'normal');
      doc.text(amount, 80, yOffset);
      yOffset += 8;

      doc.setFont('helvetica', 'bold');
      doc.text('Loan Required By:', 20, yOffset);
      doc.setFont('helvetica', 'normal');
      doc.text(loanDate, 80, yOffset);
      yOffset += 8;

      doc.setFont('helvetica', 'bold');
      doc.text('Reason for Loan:', 20, yOffset);
      doc.setFont('helvetica', 'normal');
      doc.text(reason, 80, yOffset);
      yOffset += 8;

      doc.setFont('helvetica', 'bold');
      doc.text('Repayment Months:', 20, yOffset);
      doc.setFont('helvetica', 'normal');
      doc.text(months, 80, yOffset);
      yOffset += 8;

      doc.setFont('helvetica', 'bold');
      doc.text('Repayment Start:', 20, yOffset);
      doc.setFont('helvetica', 'normal');
      doc.text(repayStart, 80, yOffset);
      yOffset += 8;

      doc.setFont('helvetica', 'bold');
      doc.text('Repayment End:', 20, yOffset);
      doc.setFont('helvetica', 'normal');
      doc.text(repayEnd, 80, yOffset);
      yOffset += 12;

      doc.setFont('helvetica', 'bold');
      doc.text('Summary:', 20, yOffset);
      yOffset += 8;
      doc.setFont('helvetica, 'normal');
      const summaryLines = doc.splitTextToSize(summary, 170);
      doc.text(summaryLines, 20, yOffset);
      yOffset += summaryLines.length * 6 + 12;

      return yOffset;
    }

    // Generate PDF
    function generatePDF() {
      const doc = new jsPDF();
      let yOffset = 20;
      yOffset = generatePDFContent(doc, yOffset);
      const signatureData = signatureCanvas.toDataURL('image/png', 1.0);
      doc.addImage(signatureData, 'PNG', 20, yOffset, 60, 30, undefined, 'FAST');
      return doc;
    }

    // Download PDF
    function downloadPDF() {
      try {
        const doc = generatePDF();
        const name = document.getElementById('name').value || 'Loan_Request';
        const today = new Date().toISOString().split('T')[0];
        doc.save(`${name}_${today}.pdf`);
      } catch (e) {
        console.error('Download PDF error:', e);
      }
    }

    // Share on WhatsApp
    function shareOnWhatsApp() {
      try {
        const doc = generatePDF();
        const name = document.getElementById('name').value || 'Loan_Request';
        const today = new Date().toISOString().split('T')[0];
        const filename = `${name}_${today}.pdf`;
        const blob = doc.output('blob');
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        if (navigator.share && !isIOS) {
          const file = new File([blob], filename, { type: 'application/pdf' });
          navigator.share({
            files: [file],
            title: 'Loan Request PDF',
            text: `Please find attached loan request PDF (${filename}).`
          })
          .then(() => console.log('Shared successfully'))
          .catch(err => {
            console.error('Web Share API error:', err);
            const url = URL.createObjectURL(blob);
            window.open(`https://wa.me/?text=Please find attached loan request PDF (${filename}). Download: ${url}`, '_blank');
          });
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          alert('PDF has been downloaded. Please open it and share via WhatsApp.');
        }
      } catch (e) {
        console.error('Share on WhatsApp error:', e);
        alert('An error occurred while sharing. Please try downloading the PDF instead.');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Load payment table
      loadPaymentTable();

      // Initialize form elements
      const repayStart = document.getElementById('repayStart');
      const repayEnd = document.getElementById('repayEnd');
      const loanDate = document.getElementById('loanDate');
      const monthsInput = document.getElementById('months');
      const reasonSelect = document.getElementById('reason');
      const otherReasonDiv = document.getElementById('otherReasonDiv');
      signatureCanvas = document.getElementById('signatureCanvas');
      ctx = signatureCanvas.getContext('2d');
      const amountInput = document.getElementById('amount');
      const amountError = document.getElementById('amountError');
      const form = document.getElementById('loanForm');

      // Set request date
      document.getElementById('requestDate').value = new Date().toISOString().split('T')[0];

      // Canvas event handlers
      setCanvasSize();

      function getMousePos(event) {
        const rect = signatureCanvas.getBoundingClientRect();
        return {
          x: event.clientX - rect.left,
          y: event.clientY - rect.top
        };
      }

      function getTouchPos(touch) {
        const rect = signatureCanvas.getBoundingClientRect();
        return {
          x: touch.clientX - rect.left,
          y: touch.clientY - rect.top
        };
      }

      function startDrawing(pos) {
        drawing = true;
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      }

      function draw(pos) {
        if (!drawing) return;
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      }

      function stopDrawing() {
        drawing = false;
        ctx.beginPath();
      }

      signatureCanvas.addEventListener('mousedown', (e) => {
        try {
          const pos = getMousePos(e);
          startDrawing(pos);
        } catch (e) {
          console.error('Mouse down error:', e);
        }
      });

      signatureCanvas.addEventListener('mousemove', (e) => {
        try {
          const pos = getMousePos(e);
          draw(pos);
        } catch (e) {
          console.error('Mouse move error:', e);
        }
      });

      signatureCanvas.addEventListener('mouseup', stopDrawing);
      signatureCanvas.addEventListener('mouseout', stopDrawing);

      signatureCanvas.addEventListener('touchstart', (e) => {
        try {
          e.preventDefault();
          const pos = getTouchPos(e.touches[0]);
          startDrawing(pos);
        } catch (e) {
          console.error('Touch start error:', e);
        }
      }, { passive: false });

      signatureCanvas.addEventListener('touchmove', (e) => {
        try {
          e.preventDefault();
          const pos = getTouchPos(e.touches[0]);
          draw(pos);
        } catch (e) {
          console.error('Touch move error:', e);
        }
      }, { passive: false });

      signatureCanvas.addEventListener('touchend', (e) => {
        try {
          e.preventDefault();
          stopDrawing();
        } catch (e) {
          console.error('Touch end error:', e);
        }
      }, { passive: false });

      // Form logic
      function autoSetRepaymentDates() {
        try {
          const loanDateValue = new Date(loanDate.value);
          const monthsToPay = parseInt(monthsInput.value);
          if (!isNaN(loanDateValue.getTime()) && monthsToPay > 0) {
            const startDate = new Date(loanDateValue);
            startDate.setMonth(startDate.getMonth() + 2);
            repayStart.valueAsDate = startDate;

            const endDate = new Date(startDate);
            endDate.setMonth(endDate.getMonth() + monthsToPay);
            repayEnd.valueAsDate = endDate;
          }
        } catch (e) {
          console.error('Auto set repayment dates error:', e);
        }
      }

      function updateRepayEndFromStart() {
        try {
          const startDate = new Date(repayStart.value);
          const months = parseInt(monthsInput.value);
          if (!isNaN(startDate.getTime()) && months > 0) {
            const endDate = new Date(startDate);
            endDate.setMonth(endDate.getMonth() + months);
            repayEnd.valueAsDate = endDate;
            generateSummary();
          }
        } catch (e) {
          console.error('Update repay end error:', e);
        }
      }

      function generateSummary() {
        try {
          const applicant = document.getElementById('name').value;
          const amount = document.getElementById('amount').value;
          const reqDate = loanDate.value;
          const reason = reasonSelect.value === 'Other' ? document.getElementById('otherReason').value : reasonSelect.value;
          const endDate = repayEnd.value;

          if (!amount || !reqDate || !endDate || !applicant || !reason) return;

          const summary = `
            Dear Avadhi Nidhi Committee,

            I would like to request for a loan of AED ${amount} on ${reqDate}
            for ${reason}.
            I will repay the loan amount completely by ${endDate}.

            Kindly approve my request.

            Requested By
            ${applicant}
          `;
          document.getElementById('summaryMessage').innerText = summary;
        } catch (e) {
          console.error('Generate summary error:', e);
        }
      }

      amountInput.addEventListener('input', () => {
        try {
          if (parseInt(amountInput.value) > 2000) {
            amountInput.classList.add('error');
            amountError.classList.remove('hidden');
          } else {
            amountInput.classList.remove('error');
            amountError.classList.add('hidden');
          }
          generateSummary();
        } catch (e) {
          console.error('Amount input error:', e);
        }
      });

      repayStart.addEventListener('change', updateRepayEndFromStart);
      monthsInput.addEventListener('input', () => {
        autoSetRepaymentDates();
        generateSummary();
      });
      reasonSelect.addEventListener('change', () => {
        otherReasonDiv.classList.toggle('hidden', reasonSelect.value !== 'Other');
        generateSummary();
      });
      loanDate.addEventListener('change', () => {
        autoSetRepaymentDates();
        generateSummary();
      });

      ['name', 'otherReason', 'repayEnd'].forEach(id => {
        document.getElementById(id).addEventListener('input', generateSummary);
      });

      // Handle form reset
      form.addEventListener('reset', () => {
        try {
          clearSignature();
          document.getElementById('summaryMessage').innerHTML = '';
          otherReasonDiv.classList.add('hidden');
        } catch (e) {
          console.error('Form reset error:', e);
        }
      });

      // Dark mode toggle
      document.getElementById('darkToggle').addEventListener('click', () => {
        document.body.classList.toggle('dark');
      });
    });
  </script>
</body>
</html>