<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loan & Payment Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding: 1rem; background: #f7f9fb; }
    h2 { margin-top: 2rem; }
    table { font-size: 0.875rem; }
    th, td { white-space: nowrap; }
    .table-responsive { max-height: 400px; overflow-x: auto; }
    .print-btn { position: fixed; top: 10px; right: 10px; z-index: 999; }
    @media print {
      .print-btn, h1 { display: none !important; }
      body { padding: 0; }
    }
  </style>
</head>
<body>

  <div class="container">
    <button class="btn btn-primary print-btn" onclick="window.print()">🖨️ Print</button>

    <h1 class="text-center mb-4">Avadhi Nidhi Loan Tracker</h1>

    <h2>📄 Payments</h2>
    <div class="table-responsive mb-5">
      <table class="table table-striped table-bordered" id="paymentsTable"></table>
    </div>

    <h2>💳 Loans</h2>
    <div class="table-responsive">
      <table class="table table-striped table-bordered" id="loansTable"></table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const today = new Date("2025-05-05");
    const loanFile = "Loan.csv";
    const paymentsFile = "payments.csv";

    function parseCSV(file, callback) {
      Papa.parse(file, {
        header: true,
        download: true,
        complete: results => callback(results.data)
      });
    }

    function buildTable(containerId, headers, rows) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');
      const tr = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        tr.appendChild(th);
      });
      thead.appendChild(tr);
      rows.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(h => {
          const td = document.createElement('td');
          td.textContent = row[h] || '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      container.appendChild(thead);
      container.appendChild(tbody);
    }

    function monthsBetween(fromDate, toDate) {
      const diff = (toDate.getFullYear() - fromDate.getFullYear()) * 12 + (toDate.getMonth() - fromDate.getMonth());
      return Math.max(0, diff);
    }

    function processLoans(data) {
      const result = data.map(row => {
        const name = row["Name"];
        const loanAmt = parseFloat(row["LOAN AMOUNT"]);
        const loanDate = new Date(row["LOAN ISSUE DATE"]);
        const months = parseInt(row["AGREED TO REPAY IN (MONTHS)"]);
        const emi = Math.round(loanAmt / months);
        const monthCols = Object.keys(row).filter(k => /^\w{3}-\d{2,4}$/.test(k));
        const repaid = monthCols.reduce((sum, col) => sum + (parseFloat(row[col]) || 0), 0);
        const monthsPassed = monthsBetween(loanDate, today);
        const paidMonths = Math.floor(repaid / emi);
        const overdueMo = Math.max(0, monthsPassed - paidMonths);
        const overdueAmt = Math.max(0, (monthsPassed * emi) - repaid);
        const balance = loanAmt - repaid;
        let status = "❌ Not Paid";
        if (isNaN(loanAmt)) status = "❌ No Loan";
        else if (monthsPassed === 0) status = "⏳ Not Yet Due";
        else if (repaid > monthsPassed * emi) status = "💰 Overpaid";
        else if (repaid === monthsPassed * emi) status = "✅ On Time";
        else if (repaid > 0 && repaid < monthsPassed * emi) status = "🟡 Partially Paid";

        const output = {
          SN: row["SN"],
          Name: name,
          "Loan Date": row["LOAN ISSUE DATE"],
          "Loan Amt": loanAmt,
          "Months": months,
          "EMI": emi,
          "Repaid": repaid,
          "Overdue Amt": overdueAmt,
          "Overdue Mo": overdueMo,
          "Status": status,
          "Balance": balance
        };
        monthCols.forEach(col => output[col] = row[col]);
        return output;
      });

      const headers = Object.keys(result[0]);
      buildTable("loansTable", headers, result);
    }

    function loadTables() {
      parseCSV(paymentsFile, data => {
        const headers = Object.keys(data[0]);
        buildTable("paymentsTable", headers, data);
      });

      parseCSV(loanFile, processLoans);
    }

    loadTables();
  </script>
</body>
</html>
