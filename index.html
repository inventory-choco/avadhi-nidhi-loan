<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loan & Payment Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding: 1rem; background: #f7f9fb; }
    h2 { margin-top: 2rem; }
    table { font-size: 0.875rem; }
    th, td { white-space: nowrap; }
    .table-responsive { max-height: 400px; overflow-x: auto; }
    .toggle-btn { margin-bottom: 1rem; }
    .loans-section { display: none; }
    .loans-section.active { display: block; }
    .summary-card { background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2rem; }
    .summary-card h3 { margin-bottom: 1rem; }
    .summary-card p { margin: 0.5rem 0; }
    @media print {
      .toggle-btn, .request-loan-btn, h1 { display: none !important; }
      body { padding: 0; }
    }
  </style>
</head>
<body>

  <div class="container">
    <h1 class="text-center mb-4">Avadhi Nidhi</h1>

    <button class="btn btn-primary request-loan-btn mb-3" onclick="window.location.href='LoanRequestForm.html'">Request for a Loan</button>

    <div class="summary-card">
      <h3>Summary</h3>
      <p><strong>Total Number of Members:</strong> <span id="totalMembers">0</span></p>
      <p><strong>Current Month Total Paid:</strong> AED <span id="currentMonthPaid">0</span></p>
      <p><strong>Current Month Outstanding Payment:</strong> AED <span id="currentMonthOutstanding">0</span></p>
      <p><strong>Total Monthly Paid:</strong> AED <span id="totalMonthlyPaid">0</span></p>
      <p><strong>Total Loan Provided:</strong> AED <span id="totalLoanProvided">0</span></p>
      <p><strong>Total Loan Repaid:</strong> AED <span id="totalLoanRepaid">0</span></p>
      <p><strong>Balance:</strong> AED <span id="balance">0</span></p>
    </div>

    <h2>📄 Payments</h2>
    <div class="table-responsive mb-5">
      <table class="table table-striped table-bordered" id="paymentsTable"></table>
    </div>

    <button class="btn btn-primary toggle-btn" onclick="toggleLoans()">Toggle Loans</button>
    <div class="loans-section" id="loansSection">
      <h2>💳 Loans</h2>
      <div class="table-responsive">
        <table class="table table-striped table-bordered" id="loansTable"></table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const today = new Date("2025-05-05");
    const loanFile = "Loan.csv";
    const paymentsFile = "payments.csv";

    function parseCSV(file, callback) {
      Papa.parse(file, {
        header: true,
        download: true,
        complete: results => callback(results.data)
      });
    }

    function buildTable(containerId, headers, rows) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');
      const tr = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        tr.appendChild(th);
      });
      thead.appendChild(tr);
      rows.forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(h => {
          const td = document.createElement('td');
          td.textContent = row[h] || '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      container.appendChild(thead);
      container.appendChild(tbody);
    }

    function monthsBetween(fromDate, toDate) {
      const diff = (toDate.getFullYear() - fromDate.getFullYear()) * 12 + (toDate.getMonth() - fromDate.getMonth());
      return Math.max(0, diff);
    }

    function processLoans(data) {
      const result = data.map(row => {
        const name = row["Name"];
        const loanAmt = parseFloat(row["LOAN AMOUNT"]);
        const loanDate = new Date(row["LOAN ISSUE DATE"]);
        const months = parseInt(row["AGREED TO REPAY IN (MONTHS)"]);
        const emi = Math.round(loanAmt / months);
        const monthCols = Object.keys(row).filter(k => /^\w{3}-\d{2,4}$/.test(k));
        const repaid = monthCols.reduce((sum, col) => sum + (parseFloat(row[col]) || 0), 0);
        const monthsPassed = monthsBetween(loanDate, today);
        const paidMonths = Math.floor(repaid / emi);
        const overdueMo = Math.max(0, monthsPassed - paidMonths);
        const overdueAmt = Math.max(0, (monthsPassed * emi) - repaid);
        const balance = loanAmt - repaid;
        let status = "❌ Not Paid";
        if (isNaN(loanAmt)) status = "❌ No Loan";
        else if (monthsPassed === 0) status = "⏳ Not Yet Due";
        else if (repaid > monthsPassed * emi) status = "💰 Overpaid";
        else if (repaid === monthsPassed * emi) status = "✅ On Time";
        else if (repaid > 0 && repaid < monthsPassed * emi) status = "🟡 Partially Paid";

        const output = {
          SN: row["SN"],
          Name: name,
          "Loan Date": row["LOAN ISSUE DATE"],
          "Loan Amt": loanAmt,
          "Months": months,
          "EMI": emi,
          "Repaid": repaid,
          "Overdue Amt": overdueAmt,
          "Overdue Mo": overdueMo,
          "Status": status,
          "Balance": balance
        };
        monthCols.forEach(col => output[col] = row[col]);
        return output;
      });

      const headers = Object.keys(result[0]);
      buildTable("loansTable", headers, result);

      // Calculate loan summary metrics
      const totalLoanProvided = result.reduce((sum, row) => sum + (isNaN(row["Loan Amt"]) ? 0 : row["Loan Amt"]), 0);
      const totalLoanRepaid = result.reduce((sum, row) => sum + (isNaN(row["Repaid"]) ? 0 : row["Repaid"]), 0);
      document.getElementById('totalLoanProvided').textContent = totalLoanProvided.toFixed(2);
      document.getElementById('totalLoanRepaid').textContent = totalLoanRepaid.toFixed(2);
      return { totalLoanProvided, totalLoanRepaid };
    }

    function processPayments(data) {
      // Filter out the TOTAL row
      const filteredData = data.filter(row => row["Name"] !== "TOTAL");
      const headers = Object.keys(filteredData[0]);
      buildTable("paymentsTable", headers, filteredData);

      // Calculate payment summary metrics
      const totalMembers = filteredData.length;
      const currentMonthPaid = filteredData.reduce((sum, row) => sum + (parseFloat(row["May-25"]) || 0), 0);
      const currentMonthOutstanding = (totalMembers * 100) - currentMonthPaid;
      const totalMonthlyPaid = filteredData.reduce((sum, row) => sum + (parseFloat(row["Total Paid"]) || 0), 0);

      // Update summary display
      document.getElementById('totalMembers').textContent = totalMembers;
      document.getElementById('currentMonthPaid').textContent = currentMonthPaid.toFixed(2);
      document.getElementById('currentMonthOutstanding').textContent = currentMonthOutstanding.toFixed(2);
      document.getElementById('totalMonthlyPaid').textContent = totalMonthlyPaid.toFixed(2);

      return { totalMembers, currentMonthPaid, totalMonthlyPaid };
    }

    function loadTables() {
      parseCSV(paymentsFile, paymentsData => {
        const paymentsMetrics = processPayments(paymentsData);
        parseCSV(loanFile, loanData => {
          const loanMetrics = processLoans(loanData);
          const balance = paymentsMetrics.totalMonthlyPaid - loanMetrics.totalLoanProvided + loanMetrics.totalLoanRepaid;
          document.getElementById('balance').textContent = balance.toFixed(2);
        });
      });
    }

    function toggleLoans() {
      const loansSection = document.getElementById('loansSection');
      loansSection.classList.toggle('active');
    }

    loadTables();
  </script>
</body>
</html>